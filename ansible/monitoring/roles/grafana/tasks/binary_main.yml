---
- name: Install dependencies
  apt:
    name:
      - wget
      - tar
    state: present
    update_cache: yes

############################################
# Fetch Grafana releases
############################################
- name: Fetch Grafana releases
  uri:
    url: https://api.github.com/repos/grafana/grafana/releases
    return_content: yes
  register: grafana_releases
  run_once: true
  delegate_to: localhost
  become: false

############################################
# Debug: List all assets for first few releases
############################################
- name: Debug - Show assets for recent releases
  debug:
    msg: |
      Release: {{ item.tag_name }}
      Assets:
      {% for asset in item.assets %}
        - {{ asset.name }}
      {% endfor %}
  loop: "{{ grafana_releases.json[0:3] }}"
  loop_control:
    label: "{{ item.tag_name }}"
  when: grafana_releases.json | length > 0
  become: false

############################################
# Find release with appropriate tarball
############################################
- name: Find suitable Grafana release
  set_fact:
    grafana_release: "{{ item }}"
  loop: "{{ grafana_releases.json }}"
  when: >
    not item.prerelease and
    not item.draft and
    item.assets is defined and
    (
      item.assets | 
      selectattr('name', 'match', 'grafana-enterprise-.*linux-amd64.*\\.tar\\.gz') |
      list | length > 0
      or
      item.assets |
      selectattr('name', 'match', 'grafana.*linux-amd64.*\\.tar\\.gz') |
      list | length > 0
      or
      item.assets |
      selectattr('name', 'match', 'linux-amd64.*\\.tar\\.gz') |
      list | length > 0
    )
  loop_control:
    label: "{{ item.tag_name }}"
    extended: true
  become: false
  register: release_found
  until: release_found is success

############################################
# Alternative: Check for different naming patterns
############################################
- name: Alternative - Find Grafana release (fallback)
  set_fact:
    grafana_release: "{{ item }}"
  loop: "{{ grafana_releases.json }}"
  when: >
    not item.prerelease and
    not item.draft and
    item.assets is defined and
    (
      item.assets |
      selectattr('name', 'match', '.*amd64\\.tar\\.gz$') |
      list | length > 0
      or
      item.assets |
      selectattr('name', 'match', '.*linux.*amd64.*\\.tar\\.gz$') |
      list | length > 0
      or
      item.assets |
      selectattr('name', 'regex_search', 'grafana.*\\d+\\.\\d+\\.\\d+.*linux.*amd64') |
      list | length > 0
    )
  loop_control:
    label: "{{ item.tag_name }}"
    extended: true
  become: false
  register: release_found_alt
  until: release_found_alt is success
  when: release_found is not defined or release_found.failed

- name: Set final release variable
  set_fact:
    grafana_release_final: "{{ grafana_release if grafana_release is defined else (release_found_alt.item if release_found_alt is defined else undefined) }}"
  become: false

- name: Fail if no valid Grafana release found
  fail:
    msg: >
      No suitable Grafana linux-amd64 tarball found.
      Checked releases: {{ grafana_releases.json | map(attribute='tag_name') | list | join(', ') }}
      
      Common patterns to look for:
      - grafana-enterprise-*-linux-amd64.tar.gz
      - grafana-*-linux-amd64.tar.gz
      - *amd64.tar.gz
      - *linux*amd64*.tar.gz
  when: grafana_release_final is not defined
  become: false

############################################
# Debug: Show selected release info
############################################
- name: Debug - Show selected release
  debug:
    msg: |
      Selected Release: {{ grafana_release_final.tag_name }}
      Assets found:
      {% for asset in grafana_release_final.assets %}
        - {{ asset.name }} ({{ asset.browser_download_url }})
      {% endfor %}
  become: false

- name: Set Grafana version and download URL
  set_fact:
    grafana_version: "{{ grafana_release_final.tag_name }}"
    grafana_download_url: >-
      {{
        grafana_release_final.assets |
        selectattr(
          'name',
          'match',
          '.*(amd64|linux.*amd64).*\\.tar\\.gz$'
        ) |
        map(attribute='browser_download_url') |
        first
      }}
  become: false

# The rest of your tasks remain the same...
############################################
# Download Grafana
############################################
- name: Download Grafana release
  get_url:
    url: "{{ grafana_download_url }}"
    dest: "/tmp/grafana-{{ grafana_version }}.tar.gz"
    mode: "0644"

############################################
# User & group
############################################
- name: Ensure grafana group exists
  group:
    name: grafana
    system: yes

- name: Ensure grafana user exists
  user:
    name: grafana
    group: grafana
    system: yes
    shell: /usr/sbin/nologin
    home: /var/lib/grafana

############################################
# Install Grafana
############################################
- name: Check existing Grafana version
  stat:
    path: /usr/local/bin/grafana/VERSION
  register: grafana_installed
  ignore_errors: yes

- name: Remove existing Grafana directory if upgrading
  file:
    path: /usr/local/bin/grafana
    state: absent
  when: grafana_installed.stat.exists == false

- name: Extract Grafana archive
  unarchive:
    src: "/tmp/grafana-{{ grafana_version }}.tar.gz"
    dest: /usr/local/bin
    remote_src: yes

# Adjust the directory name pattern based on actual downloaded file
- name: Find extracted Grafana directory
  find:
    paths: /usr/local/bin
    patterns: "grafana*"
    file_type: directory
  register: grafana_dir

- name: Rename Grafana directory
  command: >
    mv "{{ grafana_dir.files[0].path }}" /usr/local/bin/grafana
  args:
    creates: /usr/local/bin/grafana

############################################
# Permissions
############################################
- name: Set ownership on Grafana directory
  file:
    path: /usr/local/bin/grafana
    owner: root
    group: grafana
    recurse: yes

############################################
# Config
############################################
- name: Ensure /etc/grafana exists
  file:
    path: /etc/grafana
    state: directory
    owner: root
    group: grafana
    mode: "0750"

- name: Ensure grafana.ini exists
  copy:
    src: /usr/local/bin/grafana/conf/defaults.ini
    dest: /etc/grafana/grafana.ini
    remote_src: yes
    owner: root
    group: grafana
    mode: "0640"
  when: not lookup('ansible.builtin.file', '/etc/grafana/grafana.ini', errors='ignore')

- name: Ensure Grafana data directory exists
  file:
    path: /var/lib/grafana
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"

############################################
# Systemd
############################################
- name: Deploy Grafana systemd service
  template:
    src: grafana-server.service.j2
    dest: /etc/systemd/system/grafana-server.service
    mode: "0644"

- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Enable and start Grafana
  systemd:
    name: grafana-server
    enabled: yes
    state: started
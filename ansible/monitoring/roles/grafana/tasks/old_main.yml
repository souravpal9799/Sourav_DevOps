---
- name: Ensure grafana group exists
  group:
    name: grafana
    system: yes

- name: Ensure grafana user exists
  user:
    name: grafana
    group: grafana
    system: yes
    shell: /usr/sbin/nologin
    home: /var/lib/grafana

- name: Install dependencies
  apt:
    name:
      - apt-transport-https
      - wget
      - gpg
    state: present
    update_cache: yes

- name: Create apt keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Download Grafana GPG key
  get_url:
    url: https://apt.grafana.com/gpg.key
    dest: /tmp/grafana.gpg
    mode: "0644"

- name: Convert Grafana GPG key to keyring format
  command: >
    gpg --dearmor -o /etc/apt/keyrings/grafana.gpg /tmp/grafana.gpg
  args:
    creates: /etc/apt/keyrings/grafana.gpg

- name: Add Grafana stable repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
    filename: grafana
    state: present

- name: Add Grafana beta repository
  apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com beta main"
    filename: grafana
    state: present

- name: Install Grafana
  apt:
    name: grafana
    state: present

- name: Ensure /etc/grafana directory exists
  file:
    path: /etc/grafana
    state: directory
    owner: root
    group: grafana
    mode: "0750"

- name: Ensure grafana.ini exists
  copy:
    src: /usr/share/grafana/conf/defaults.ini
    dest: /etc/grafana/grafana.ini
    remote_src: yes
    owner: root
    group: grafana
    mode: "0640"
  when: not lookup('ansible.builtin.file', '/etc/grafana/grafana.ini', errors='ignore')

- name: Ensure Grafana data directory exists
  file:
    path: /var/lib/grafana
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"

- include_tasks: prometheus_dashboard.yml
- include_tasks: loki.yml

- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Enable and start Grafana
  systemd:
    name: grafana-server
    enabled: yes
    state: started

global:
  scrape_interval: {{ scrape_interval | default('30s') }}
  evaluation_interval: {{ evaluation_interval | default('30s') }}

alerting:
  alertmanagers:
    - static_configs:
        - targets:
{% for target in alertmanager_targets %}
            - {{ target }}
{% endfor %}

rule_files:
{% for rule in rule_files %}
  - {{ rule }}
{% endfor %}

scrape_configs:

  # -------------------------------------------------
  # Prometheus self-scrape (monitoring server)
  # -------------------------------------------------
  - job_name: prometheus
    static_configs:
      - targets:
{% for target in prometheus_targets %}
          - {{ target }}
{% endfor %}

  # -------------------------------------------------
  # Node Exporter (ONLY web servers)
  # -------------------------------------------------
  - job_name: node_exporter
    static_configs:
{% for host in groups['prometheus_agents'] %}
      - targets:
          - {{ hostvars[host].public_ip_addr }}:{{ node_exporter_port }}
        labels:
          hostname: "{{ host }}"
{% endfor %}

  # -------------------------------------------------
  # Blackbox URL monitoring (from blackbox_urls)
  # -------------------------------------------------
{% for site, urls in blackbox_urls.items() %}
  - job_name: "blackbox_url_{{ site }}"
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
{% for url in urls %}
          - {{ url }}
{% endfor %}
        labels:
          site: "{{ site }}"
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "{{ hostvars['web'].private_ip_addr }}:{{ blackbox_exporter_port }}"
{% endfor %}

  # -------------------------------------------------
  # Blackbox HTTP (web servers)
  # -------------------------------------------------
  - job_name: blackbox_http
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
{% for host in groups['prometheus_agents'] %}
      - targets:
          - http://{{ hostvars[host].public_ip_addr }}:80
        labels:
          hostname: "{{ host }}"
{% endfor %}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "{{ hostvars['web'].private_ip_addr }}:{{ blackbox_exporter_port }}"

  # -------------------------------------------------
  # Blackbox HTTPS (web servers)
  # -------------------------------------------------
  - job_name: blackbox_https
    metrics_path: /probe
    params:
      module: [https_2xx]
    static_configs:
{% for host in groups['prometheus_agents'] %}
      - targets:
          - https://{{ hostvars[host].public_ip_addr }}:443
        labels:
          hostname: "{{ host }}"
{% endfor %}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "{{ hostvars['web'].private_ip_addr }}:{{ blackbox_exporter_port }}"

  # -------------------------------------------------
  # Blackbox TCP ports (web servers)
  # -------------------------------------------------
  - job_name: blackbox_tcp_ports
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
{% for host in groups['prometheus_agents'] %}
{% for port in blackbox_tcp_ports %}
      - targets:
          - {{ hostvars[host].public_ip_addr }}:{{ port }}
        labels:
          hostname: "{{ host }}"
          port: "{{ port }}"
{% endfor %}
{% endfor %}
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: "{{ hostvars['web'].private_ip_addr }}:{{ blackbox_exporter_port }}"
